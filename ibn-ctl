#!/bin/bash
# ibn-ctl - Master Terminal Suite for IBN Network

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="${PROJECT_ROOT}/network/scripts"
COMPOSE_DIR="${PROJECT_ROOT}/network/compose"
export COMPOSE_PROJECT_NAME=fabric
export COMPOSE_IGNORE_ORPHANS=True

# Discover all modular compose files
COMPOSE_FILES="-f ${COMPOSE_DIR}/docker-compose-base.yaml"
if [ -d "${COMPOSE_DIR}" ]; then
    for f in "${COMPOSE_DIR}"/docker-compose-org*.yaml "${COMPOSE_DIR}"/docker-compose-orderers.yaml; do
        if [ -f "$f" ]; then
            COMPOSE_FILES="${COMPOSE_FILES} -f $f"
        fi
    done
fi

# Colors for UI
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

function show_header() {
    clear
    echo -e "${CYAN}${BOLD}"
    echo "  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     "
    echo "  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     "
    echo "  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     "
    echo "  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë     "
    echo "  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó"
    echo "  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "         ${BLUE}The Superadmin Blockchain Toolkit${NC}\n"
}

function usage() {
    echo -e "Usage: ${BOLD}./ibn-ctl [command]${NC}"
    echo ""
    echo "Commands:"
    echo "  health      Check ledger heights and synchronization"
    echo "  stats       Monitor CPU/RAM/Network resources"
    echo "  scale       Add a new organization (Auto-ID allocation)"
    echo "  orderer     Scale Ordering Service (Add Raft Node)"
    echo "  drop-order  Remove an orderer node from cluster"
    echo "  freeze      Restrict an organization's ledger rights"
    echo "  remove      Permanently excise an organization from channel"
    echo "  peer        Add a new peer and join channel (optional)"
    echo "  deploy      Lifecycle: Approve and Commit chaincode (Batch)"
    echo "  profiles    Generate Connection Profiles for all orgs"
    echo "  onboard     Register/Enroll a new client user"
    echo "  fresh       Fresh Start: Reset and build network from scratch"
    echo "  down        Stop and wipe the entire network"
    echo "  -i          Enter Interactive Menu mode (default)"
    echo ""
}

function interactive_menu() {
    while true; do
        show_header
        echo -e "${BOLD}MAIN MENU${NC}"
        echo "1) üè• Network Health        Check sync and ledger status"
        echo "2) üìä Resource Monitor      Real-time CPU/RAM/NET dashboard"
        echo "3) üèóÔ∏è  Scale Network      Add a new Organization (Org Factory)"
        echo "4) ‚ûï Add Peer Node      Expand an Org with a new peer"
        echo "5) üó≥Ô∏è  Add Orderer Node    Scale Raft Consensus Cluster"
        echo "6) üì¶ Chaincode Lifecycle   Approve & Commit (Batch Mode)"
        echo "7) üìá Generate Profiles     Create SDK Connection JSONs"
        echo "8) üë§ Onboard Client       Register new app user"
        echo "9) ‚ùÑÔ∏è  Freeze Org          Restrict an organization"
        echo "10) üóëÔ∏è  Remove Org          Permanently excise an organization"
        echo "11) üöú Remove Orderer      Exise a node from Raft Cluster"
        echo "12) üí• Fresh Start          Reset and Rebuild Network"
        echo "13) üõë Network Shutdown    Stop and wipe all data"
        echo "14) üì∫ Create Channel       Provision a new App Channel"
        echo "15) ‚öì Sync Anchors         Update cross-org discovery"
        echo "16) üì¶ Atomic Upgrade       Increment version & rollout"
        echo "17) üßê Audit Channel       Inspect Governance & Anchors"
        echo "18) üìã Org Logs            Stream logs by Organization"
        echo "19) üö™ Exit"
        echo ""
        read -p "Select an option: " opt

        case $opt in
            1) "${SCRIPTS_DIR}/network-health.sh" ;;
            2) "${SCRIPTS_DIR}/network-resource-monitor.sh" ;;
            3) "${SCRIPTS_DIR}/add-org.sh" ;;
            4)
                read -p "Target Org Num (e.g. 1): " orgn
                read -p "Channel Name (mychannel): " chan
                chan=${chan:-mychannel}
                "${SCRIPTS_DIR}/add-peer.sh" "auto" "org${orgn}" "$chan"
                ;;
            5) "${SCRIPTS_DIR}/add-orderer.sh" ;;
            6)
                read -p "CC Name (basic): " ccname
                ccname=${ccname:-basic}
                read -p "Version (1.0): " ccver
                ccver=${ccver:-1.0}
                read -p "Sequence: " ccseq
                "${SCRIPTS_DIR}/mass-approve.sh" "$ccname" "$ccver" "$ccseq"
                "${SCRIPTS_DIR}/mass-commit.sh" "$ccname" "$ccver" "$ccseq"
                ;;
            7) "${SCRIPTS_DIR}/profile-gen.sh" ;;
            8)
                read -p "Client ID: " cid
                read -p "Org Name (org1): " oname
                "${SCRIPTS_DIR}/enroll-client.sh" "$cid" "$oname"
                ;;
            9)
                read -p "Enter Org Num to Freeze: " fnum
                "${SCRIPTS_DIR}/freeze-org.sh" "$fnum"
                ;;
            10)
                read -p "Enter Org Num to Remove: " rnum
                "${SCRIPTS_DIR}/remove-org.sh" "$rnum"
                ;;
            11)
                read -p "Enter Orderer Num to Remove (Empty for auto-detect): " rnum
                "${SCRIPTS_DIR}/remove-orderer.sh" "$rnum"
                ;;
            12)
                echo -e "${RED}${BOLD}üî• CRITICAL: Total network reset.${NC}"
                read -p "Proceed with Fresh Start? (y/N): " confirm
                if [[ $confirm == [yY] ]]; then "${PROJECT_ROOT}/fresh-start.sh"; fi
                ;;
            13) 
                echo -e "${RED}${BOLD}WARNING: This will delete ALL ledger data.${NC}"
                read -p "Are you sure? (y/N): " confirm
                if [[ $confirm == [yY] ]]; then "${SCRIPTS_DIR}/network-down.sh"; fi
                ;;
            14)
                read -p "Enter New Channel Name: " cname
                if [ -n "$cname" ]; then "${SCRIPTS_DIR}/create-channel.sh" "$cname"; fi
                ;;
            15)
                read -p "Enter Org Num to Sync Anchors: " snum
                read -p "Channel Name (mychannel): " schan
                schan=${schan:-mychannel}
                "${SCRIPTS_DIR}/sync-anchors.sh" "$snum" "$schan"
                ;;
            16)
                read -p "CC Name (basic): " uccn
                uccn=${uccn:-basic}
                read -p "Channel (mychannel): " uchan
                uchan=${uchan:-mychannel}
                echo -e "Policy Types: ${CYAN}MAJORITY, ALL, ANY, VETO, ANY_2${NC}"
                read -p "Select Policy (MAJORITY): " upol
                upol=${upol:-MAJORITY}
                "${SCRIPTS_DIR}/upgrade-cc.sh" "$uccn" "$uchan" "$upol"
                ;;
            17)
                read -p "Channel (mychannel): " achan
                achan=${achan:-mychannel}
                "${SCRIPTS_DIR}/audit-channel.sh" "$achan"
                ;;
            18)
                read -p "Enter Org Num: " lnum
                "${SCRIPTS_DIR}/org-logs.sh" "$lnum"
                ;;
            19|exit|quit) exit 0 ;;
            *) echo -e "${RED}Invalid option${NC}" ;;
        esac
        echo -e "\n${YELLOW}Press Enter to return to menu...${NC}"
        read
    done
}

# Main routing
if [ -z "$1" ] || [ "$1" == "-i" ]; then
    interactive_menu
else
    case $1 in
        health)     "${SCRIPTS_DIR}/network-health.sh" ;;
        stats)      "${SCRIPTS_DIR}/network-resource-monitor.sh" ;;
        scale)      "${SCRIPTS_DIR}/add-org.sh" ;;
        orderer)    "${SCRIPTS_DIR}/add-orderer.sh" ;;
        drop-order) "${SCRIPTS_DIR}/remove-orderer.sh" "$2" ;;
        freeze)     "${SCRIPTS_DIR}/freeze-org.sh" "$2" ;;
        remove)     "${SCRIPTS_DIR}/remove-org.sh" "$2" ;;
        peer)       "${SCRIPTS_DIR}/add-peer.sh" "$2" "$3" "$4" ;;
        approve)    "${SCRIPTS_DIR}/mass-approve.sh" "$2" "$3" "$4" ;;
        commit)     "${SCRIPTS_DIR}/mass-commit.sh" "$2" "$3" "$4" ;;
        profiles)   "${SCRIPTS_DIR}/profile-gen.sh" ;;
        onboard)    "${SCRIPTS_DIR}/enroll-client.sh" "$2" "$3" ;;
        fresh)      "${PROJECT_ROOT}/fresh-start.sh" ;;
        down)       "${SCRIPTS_DIR}/network-down.sh" ;;
        chan)       "${SCRIPTS_DIR}/create-channel.sh" "$2" ;;
        upgrade)    "${SCRIPTS_DIR}/upgrade-cc.sh" "$2" "$3" "$4" ;;
        audit)      "${SCRIPTS_DIR}/audit-channel.sh" "$2" ;;
        logs)       "${SCRIPTS_DIR}/org-logs.sh" "$2" ;;
        help)       usage ;;
        *)          echo -e "${RED}Unknown command: $1${NC}"; usage; exit 1 ;;
    esac
fi
